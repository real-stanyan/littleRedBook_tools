import time
import random  # æ–°å¢ï¼šç”¨äºéšæœºæŠ½å–
import config
from logger import LogManager
from device_manager import connect_device_robust
from ai_engine import DualAIAgent
from bot_actions import start_app_and_search, process_single_post

# ==========================================
# ğŸ“‹ é¢„è®¾å…³é”®è¯åº“ (1-100)
# ==========================================
KEYWORDS_POOL = [
    "æ¾³æ´² æ€»æ˜¯ å¾ˆ ç´¯", "æ¾³æ´² å®¹æ˜“ ç–²åŠ³", "æ¾³æ´² ç²¾åŠ› æ¢å¤ æ…¢", "æ¾³æ´² èº«ä½“ æ¢å¤ ä¸è¿‡æ¥", "æ¾³æ´² ç¡ å¾ˆä¹… è¿˜æ˜¯ ç´¯",
    "æ¾³æ´² æ€»è§‰å¾— æ²¡ åŠ›", "æ¾³æ´² ç™½å¤© å‘å›°", "æ¾³æ´² è„‘å­ ä¸ æ¸…é†’", "æ¾³æ´² æ³¨æ„åŠ› ä¸ é›†ä¸­", "æ¾³æ´² æ—©ä¸Š èµ·ä¸æ¥",
    "æ¾³æ´² å·¥ä½œ ä¸€ç´¯ å°± æ‰›ä¸ä½", "æ¾³æ´² ä¸‹åˆ ä½ç”µé‡", "æ¾³æ´² æ…¢æ€§ ç‚ç—‡", "æ¾³æ´² ç‚ç—‡ çŠ¶æ€", "æ¾³æ´² èº«ä½“ å‘ç‚",
    "æ¾³æ´² å®¹æ˜“ å‘ç‚", "æ¾³æ´² åå¤ å‘ç‚", "æ¾³æ´² çŠ¶æ€ ä¸€ç›´ ä¸ ç¨³å®š", "æ¾³æ´² ä½“å†… ç‚ç—‡", "æ¾³æ´² å‘ç‚ ä½“è´¨",
    "æ¾³æ´² å®¹æ˜“ ä¸Šç« å‘ç‚", "æ¾³æ´² èº«ä½“ æ€»æ˜¯ ä¸ èˆ’æœ", "æ¾³æ´² èº«ä½“ é…¸ç—› åå¤", "æ¾³æ´² é•¿æœŸ ä¸ é€‚", "æ¾³æ´² å…³èŠ‚ ä¸é€‚",
    "æ¾³æ´² å…³èŠ‚ åƒµ", "æ¾³æ´² èµ·åºŠ å…³èŠ‚ åƒµ", "æ¾³æ´² è¿åŠ¨ å å…³èŠ‚", "æ¾³æ´² è†ç›– ä¸èˆ’æœ", "æ¾³æ´² æ‰‹æŒ‡ åƒµ",
    "æ¾³æ´² è‚©é¢ˆ åƒµç¡¬", "æ¾³æ´² å…³èŠ‚ å¡ä½ çš„ æ„Ÿè§‰", "æ¾³æ´² èµ°è·¯ è†ç›– ç–¼", "æ¾³æ´² ä¸Šä¸‹æ¥¼ è†ç›– ä¸è¡Œ", "æ¾³æ´² ä¹…å è…° èƒŒ ä¸é€‚",
    "æ¾³æ´² èº«ä½“ åƒµ ç¡¬", "æ¾³æ´² å¾ªç¯ ä¸å¥½", "æ¾³æ´² æ‰‹è„š å†·", "æ¾³æ´² å®¹æ˜“ æ‰‹è„š å†·", "æ¾³æ´² æœ«æ¢¢ å¾ªç¯",
    "æ¾³æ´² è¡€æ¶² å¾ªç¯ ä¸å¥½", "æ¾³æ´² å†¬å¤© æ‰‹è„š å†·", "æ¾³æ´² ä¹…å æ‰‹è„š å†·", "æ¾³æ´² å†· å¾— ä¸ è¡Œ", "æ¾³æ´² å¿ƒè¡€ç®¡ å¥åº·",
    "æ¾³æ´² è¡€è„‚ åé«˜", "æ¾³æ´² ä½“æ£€ è¡€è„‚", "æ¾³æ´² ç”˜æ²¹ä¸‰é…¯ åé«˜", "æ¾³æ´² èƒ†å›ºé†‡ åé«˜", "æ¾³æ´² è¡€è„‚ æŒ‡æ ‡",
    "æ¾³æ´² ä½“æ£€ æŒ‡æ ‡ å¼‚å¸¸", "æ¾³æ´² ä½“æ£€ æŠ¥å‘Š çœ‹ä¸æ‡‚", "æ¾³æ´² ä½“æ£€ å‡ºæ¥ æœ‰ç‚¹ å“åˆ°", "æ¾³æ´² ä½“æ£€ å ç„¦è™‘", "æ¾³æ´² å‹åŠ› å¤§ èº«ä½“",
    "æ¾³æ´² ä½œæ¯ ä¹± èº«ä½“", "æ¾³æ´² ç†¬å¤œ èº«ä½“ çŠ¶æ€", "æ¾³æ´² ç¡çœ  è´¨é‡ å·®", "æ¾³æ´² ç¡ä¸è¸å®", "æ¾³æ´² æ—©é†’",
    "æ¾³æ´² ç¡çœ  æ–­æ–­ç»­ç»­", "æ¾³æ´² ç¡ä¸å¥½ è¿˜ å¾ˆ ç´¯", "æ¾³æ´² ç„¦è™‘ å½±å“ ç¡çœ ", "æ¾³æ´² å‹åŠ› å½±å“ çŠ¶æ€", "æ¾³æ´² ä¹…å èº«ä½“ ä¸é€‚",
    "æ¾³æ´² ä¹…å è…°é…¸", "æ¾³æ´² åŠå…¬å®¤ ä¹…å ä¸é€‚", "æ¾³æ´² ç«™èµ·æ¥ å¤´æ™•", "æ¾³æ´² èµ°ä¸¤æ­¥ å°± ç´¯", "æ¾³æ´² è¿åŠ¨ å æ¢å¤ æ…¢",
    "æ¾³æ´² è¿åŠ¨ å æ›´ ç´¯", "æ¾³æ´² è¿åŠ¨ å é…¸ç—› å¾ˆä¹…", "æ¾³æ´² è®­ç»ƒ å çŠ¶æ€ å·®", "æ¾³æ´² å¥èº« å ç–²æƒ«", "æ¾³æ´² å¹´çºª ä¸Šæ¥ èº«ä½“",
    "æ¾³æ´² 30å² å èº«ä½“ å˜åŒ–", "æ¾³æ´² 40å² å çŠ¶æ€", "æ¾³æ´² ä»£è°¢ å˜æ…¢", "æ¾³æ´² èº«ä½“ ä¸å¦‚ ä»¥å‰", "æ¾³æ´² æ€»è§‰å¾— è€å¾—å¿«",
    "æ¾³æ´² èº«ä½“ å˜å¾— æ•æ„Ÿ", "æ¾³æ´² å°æ¯›ç—… å˜å¤š", "æ¾³æ´² é¥®é£Ÿ æ²¹è…» èº«ä½“", "æ¾³æ´² å¤–é£Ÿ å¤š èº«ä½“", "æ¾³æ´² åƒå¾— éšä¾¿ çŠ¶æ€ å·®",
    "æ¾³æ´² é¥®é£Ÿ ä¸è§„å¾‹", "æ¾³æ´² åƒå®Œ æ›´ ç´¯", "æ¾³æ´² åƒå®Œ æ˜æ˜æ²‰æ²‰", "æ¾³æ´² æ²¹è„‚ æ‘„å…¥ å¤š", "æ¾³æ´² é¥®é£Ÿ ç»“æ„ ä¹±",
    "æ¾³æ´² çš®è‚¤ çŠ¶æ€ åå¤", "æ¾³æ´² å®¹æ˜“ é•¿ ç—˜", "æ¾³æ´² çš®è‚¤ ç‚ç—‡", "æ¾³æ´² çš®è‚¤ çº¢ çº¢ çš„", "æ¾³æ´² çš®è‚¤ çŠ¶æ€ ä¸ ç¨³",
    "æ¾³æ´² èº«ä½“ ç‚ç—‡ çš®è‚¤", "æ¾³æ´² é•¿æœŸ ä½èƒ½é‡", "æ¾³æ´² çŠ¶æ€ ä¸€ç›´ æ‹‰å®", "æ¾³æ´² æƒ³ æ”¹å–„ ä½† ä¸ çŸ¥é“ ä»å“ª å¼€å§‹", "æ¾³æ´² æƒ³ è°ƒæ•´ çŠ¶æ€"
]

def generate_search_query():
    """
    ğŸ² éšæœºç”Ÿæˆæœç´¢è¯
    è§„åˆ™ï¼šä»åº“ä¸­é€‰ä¸€è¡Œ -> å¿…é¡»åŒ…å«'æ¾³æ´²' -> å†ä»è¯¥è¡Œå‰©ä½™è¯ä¸­éšæœºé€‰2ä¸ª
    """
    # 1. éšæœºé€‰ä¸€è¡Œ
    raw_line = random.choice(KEYWORDS_POOL)
    
    # 2. æ‹†åˆ†è¯ç»„ (å»æ‰å¯èƒ½å­˜åœ¨çš„æ•°å­—ç¼–å·ï¼Œç›´æ¥æŒ‰ç©ºæ ¼åˆ‡åˆ†)
    # å‡è®¾ raw_line æ˜¯ "æ¾³æ´² æ€»æ˜¯ å¾ˆ ç´¯"
    words = raw_line.split()
    
    # è¿‡æ»¤æ‰éä¸­æ–‡å­—ç¬¦ï¼ˆæ¯”å¦‚å‰é¢çš„æ•°å­—ç¼–å· 01, 02 ç­‰ï¼Œå¦‚æœåˆ—è¡¨é‡ŒåŒ…å«äº†æ•°å­—ï¼‰
    # ä½†ä¸Šé¢çš„åˆ—è¡¨æˆ‘å·²ç»å¸®ä½ æ¸…æ´—äº†æ•°å­—ï¼Œç›´æ¥ç”¨å³å¯
    
    base_word = "æ¾³æ´²"
    other_words = [w for w in words if w != base_word]
    
    # 3. éšæœºé€‰2ä¸ªè¯ï¼ˆå¦‚æœä¸è¶³2ä¸ªå°±å…¨é€‰ï¼‰
    if len(other_words) >= 2:
        selected_others = random.sample(other_words, 2)
    else:
        selected_others = other_words
        
    # 4. ç»„åˆæœ€ç»ˆæœç´¢è¯
    final_query = f"{base_word} {' '.join(selected_others)}"
    return final_query

def run():
    # 1. è¿æ¥è®¾å¤‡ (å…ˆè¿æ¥è®¾å¤‡ï¼Œæˆ–è€…å…ˆåˆå§‹åŒ–AIéƒ½å¯ä»¥)
    # å»ºè®®å…ˆåˆå§‹åŒ– AIï¼Œå› ä¸ºè¦ç«‹åˆ»ç”¨æ¥ä¼˜åŒ–å…³é”®è¯
    try:
        agent = DualAIAgent() # åˆå§‹åŒ– AI å¼•æ“
    except Exception as e:
        print(f"âŒ AI åˆå§‹åŒ–å¤±è´¥: {e}")
        return

    try:
        d = connect_device_robust(config.SERIAL)
        w, h = d.window_size()
        print(f"ğŸ“± è®¾å¤‡åˆ†è¾¨ç‡: {w}x{h}")
    except Exception as e:
        print(f"âŒ è®¾å¤‡è¿æ¥å¤±è´¥: {e}")
        return

    # 2. ä»åº“ä¸­éšæœºé€‰ä¸€æ¡â€œåŸå§‹ç—›ç‚¹â€
    raw_pain_point = random.choice(KEYWORDS_POOL)
    
    # 3. ğŸ”¥ è®© AI ä¼˜åŒ–æˆâ€œæœç´¢è¯â€
    search_keyword = agent.optimize_keyword(raw_pain_point)
    
    print(f"\n========================================")
    print(f"ğŸ¤• åŸå§‹ç—›ç‚¹: {raw_pain_point}")
    print(f"âœ¨ AI ä¼˜åŒ–å: ã€{search_keyword}ã€‘")
    print(f"========================================\n")

    try:
        target_count = 5 
    except:
        target_count = 5

    # 4. åˆå§‹åŒ–æ—¥å¿— (ç”¨ä¼˜åŒ–åçš„è¯åšæ–‡ä»¶å)
    logger = LogManager(search_keyword)

    # 5. å¯åŠ¨å¹¶æœç´¢ (ä¼ å…¥ä¼˜åŒ–åçš„è¯)
    try:
        start_app_and_search(d, search_keyword, logger)

        processed = 0
        while processed < target_count:
            # ... (ä¸‹é¢çš„å¾ªç¯é€»è¾‘å®Œå…¨ä¿æŒä¸å˜) ...
            processed += 1
            logger.write_line(f"\nğŸ”„ [æµç¨‹è¿›åº¦ {processed}/{target_count}] æ­£åœ¨åˆ—è¡¨é¡µé€‰è´´...")
            
            feed_img = "temp_feed.jpg"
            d.screenshot(feed_img)
            
            choice_idx = agent.choose_feed_post(feed_img)
            logger.write_line(f"ğŸ¯ AI é€‰æ‹©äº†ä½ç½®: {choice_idx}")

            if choice_idx == 1:
                click_x, click_y = w * 0.25, h * 0.40
            elif choice_idx == 2:
                click_x, click_y = w * 0.75, h * 0.40
            elif choice_idx == 3:
                click_x, click_y = w * 0.25, h * 0.75
            else: 
                click_x, click_y = w * 0.75, h * 0.75
            
            d.click(click_x, click_y)
            time.sleep(3) 

            process_single_post(d, agent, processed, logger)

            if processed < target_count:
                logger.write_line("ğŸ“‰ ä¸‹æ»‘æŸ¥çœ‹æ›´å¤šå¸–å­...")
                d.swipe(w * 0.5, h * 0.8, w * 0.5, h * 0.2, duration=0.1)
                time.sleep(4) 
            else:
                logger.write_line("ğŸ›‘ ä»»åŠ¡å…¨éƒ¨å®Œæˆï¼")
                
    except Exception as e:
        logger.write_line(f"âŒ è¿è¡Œé”™è¯¯: {e}")
        import traceback
        traceback.print_exc()

if __name__ == "__main__":
    run()